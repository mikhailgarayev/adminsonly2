<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admins Only Management Panel</title>
  <!-- Firebase SDK (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap">
  <style>
    /* Общий сброс и базовые стили */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }
    html, body {
      width: 100%;
      min-height: 100vh;
    }
    /* Фоновое изображение на всю страницу */
    body {
      background: url("background2.png") no-repeat center center fixed;
      background-size: cover;
      display: flex;
      flex-direction: column;
    }
    /* Верхняя панель */
    .top-bar {
      height: 60px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }
    .top-bar h1 {
      font-size: 1.2rem;
      color: #333;
    }
    .top-bar button {
      background-color: #00c2ff;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-weight: 500;
      padding: 10px 16px;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .top-bar button:hover {
      background-color: #00a9dc;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    /* Основной контейнер с таблицами */
    .container {
      max-width: 1200px;
      width: 100%;
      margin: 20px auto;
      padding: 0 20px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    .card h2 {
      margin-bottom: 10px;
      color: #333;
      font-size: 1.1rem;
      font-weight: 600;
    }
    /* Таблицы */
    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      background: #fff;
    }
    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
      text-align: left;
      color: #333;
    }
    th {
      background-color: #f7f7f7;
      font-weight: 600;
    }
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tbody tr:hover {
      background-color: #e6f7ff;
    }
    a {
      color: #00c2ff;
      text-decoration: none;
      font-weight: 500;
    }
    a:hover {
      text-decoration: underline;
    }
    /* Модальное окно */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 500px;
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .modal.show {
      opacity: 1;
      transform: translateY(0);
    }
    .modal h2 {
      margin-bottom: 15px;
      font-size: 1.1rem;
      color: #333;
    }
    .modal form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .modal label {
      font-weight: 500;
      color: #333;
    }
    .modal input, .modal select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      outline: none;
      font-size: 0.9rem;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }
    .modal button {
      background-color: #00c2ff;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-weight: 500;
      padding: 10px 16px;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .modal button:hover {
      background-color: #00a9dc;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    /* Прогресс-бар (если требуется) */
    .progress-container {
      width: 100px;
      height: 8px;
      background-color: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin: 0 auto 4px auto;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background-color: #00c2ff;
      width: 0%;
      transition: width 0.5s ease;
    }
    .time-text {
      font-size: 0.85rem;
      color: #555;
    }
    /* Кнопки для действий в таблице */
    .btn {
      padding: 6px 12px;
      background-color: #00c2ff;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 0.8rem;
      margin-right: 5px;
    }
    .btn:hover {
      background-color: #00a9dc;
    }
  </style>
</head>
<body>
  <!-- Верхняя панель -->
  <div class="top-bar">
    <h1>Admins only management panel</h1>
    <button id="addVenueBtn">Add venue</button>
  </div>

  <!-- Основной контейнер с таблицами -->
  <div class="container">
    <div class="card">
      <h2>Active Venues</h2>
      <table id="activeTable">
        <thead>
          <tr>
            <th>Venue Name</th>
            <th>Added By</th>
            <th>Reason</th>
            <th>URL</th>
            <th>Time Left</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Активные заведения будут здесь (данные из Firebase) -->
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>History</h2>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Venue Name</th>
            <th>Added By</th>
            <th>Reason</th>
            <th>URL</th>
            <th>Offline Until</th>
          </tr>
        </thead>
        <tbody>
          <!-- Истекшие заведения -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Модальное окно для добавления заведения -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="venueModal">
      <h2>New Venue</h2>
      <form id="venueForm">
        <label>Your e-mail:</label>
        <input type="text" id="modalAddedBy" required>

        <label>Venue Name:</label>
        <input type="text" id="modalName" required>

        <label>Venue page URL:</label>
        <input type="url" id="modalUrl" required>

        <label>Offline time (in minutes):</label>
        <input type="number" id="modalOfflineTime" required min="1">

        <label>Reason for Offline:</label>
        <select id="modalReason" required>
          <option value="" disabled selected>Select reason</option>
          <option value="Integration issues / Tech issues">Integration issues / Tech issues</option>
          <option value="Venue sets itself online">Venue sets itself online</option>
        </select>

        <div class="modal-actions">
          <button type="button" id="cancelModalBtn">Cancel</button>
          <button type="submit" id="submitModalBtn">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ------------- Firebase Initialization -------------
    const firebaseConfig = {
      apiKey: "AIzaSyBaQYzQmld5VNA_wSI8nDtqENN0TgcNqeA",
      authDomain: "adminsonly.firebaseapp.com",
      databaseURL: "https://adminsonly-default-rtdb.firebaseio.com",
      projectId: "adminsonly",
      storageBucket: "adminsonly.firebasestorage.app",
      messagingSenderId: "194528429901",
      appId: "1:194528429901:web:805ca2f1dd0feca2de1904"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ------------- Webhook URLs -------------
    const restaurantWebhookURL = "https://hooks.slack.com/triggers/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";
    const simoWebhookURL = "https://hooks.slack.com/triggers/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";

    // ------------- Functions to send notifications -------------
    // Уведомление в ресторанный канал отправляется только при создании заведения.
    function sendRestaurantNotification(message) {
      fetch(restaurantWebhookURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: message })
      })
      .then(() => console.log("Restaurant notification sent."))
      .catch(err => console.error("Restaurant webhook error:", err));
    }
    // Уведомления для SIMO отправляются при всех событиях.
    function sendSimoNotification(message) {
      // Для SIMO заменяем переводы строки на разделитель, чтобы избежать ошибки invalid blocks
      const plainMessage = message.replace(/\n/g, " | ");
      fetch(simoWebhookURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: plainMessage })
      })
      .then(() => console.log("SIMO notification sent."))
      .catch(err => console.error("SIMO webhook error:", err));
    }

    // ------------- Add Venue Function -------------
    function addEstablishment(est) {
      const newRef = db.ref("establishments").push();
      est.id = newRef.key;
      est.createdAt = new Date().toISOString();
      est.graceExpiresAt = null;
      est.expired = false;
      est.extraTimeAdded = false;
      newRef.set(est, error => {
        if (!error) {
          const restMsg = `📢 The ${est.name} venue was set admins only until ${new Date(est.offlineUntil).toLocaleString()} by ${est.addedBy}\nReason: ${est.reason}. For further updates please, use https://wo.lt/adminsonly`;
          const simoMsg = `🍽️ [SIMO] Venue: ${est.name} is set admins only until ${new Date(est.offlineUntil).toLocaleString()}\n🔗 URL: ${est.url}\nReason: ${est.reason}\nBy: ${est.addedBy}`;
          
          // Отправляем уведомление для ресторана (только один раз при создании)
          sendRestaurantNotification(restMsg);
          // Отправляем подробное уведомление для SIMO
          sendSimoNotification(simoMsg);
        } else {
          console.error("Save error:", error);
        }
      });
    }

    // ------------- Global store -------------
    let currentEstablishments = [];

    // ------------- Subscribe to Firebase updates -------------
    function subscribeToDashboard() {
      db.ref("establishments").on("value", snapshot => {
        const data = snapshot.val();
        currentEstablishments = data ? Object.values(data) : [];
        renderDashboards(currentEstablishments);
      });
    }

    // ------------- Render tables -------------
    function renderDashboards(establishments) {
      const activeTbody = document.getElementById("activeTable").querySelector("tbody");
      const historyTbody = document.getElementById("historyTable").querySelector("tbody");
      
      activeTbody.innerHTML = "";
      historyTbody.innerHTML = "";
      let activeCount = 0;
      
      establishments.forEach(est => {
        if (est.expired) {
          const tr = document.createElement("tr");
          
          const tdName = document.createElement("td");
          tdName.textContent = est.name;
          tr.appendChild(tdName);
          
          const tdBy = document.createElement("td");
          tdBy.textContent = est.addedBy || "";
          tr.appendChild(tdBy);
          
          const tdReason = document.createElement("td");
          tdReason.textContent = est.reason || "";
          tr.appendChild(tdReason);
          
          const tdUrl = document.createElement("td");
          const link = document.createElement("a");
          link.href = est.url;
          link.target = "_blank";
          link.textContent = "Link";
          tdUrl.appendChild(link);
          tr.appendChild(tdUrl);
          
          const tdOffline = document.createElement("td");
          tdOffline.textContent = new Date(est.offlineUntil).toLocaleString();
          tr.appendChild(tdOffline);
          
          historyTbody.appendChild(tr);
        } else {
          activeCount++;
          const tr = document.createElement("tr");
          
          const tdName = document.createElement("td");
          tdName.textContent = est.name;
          tr.appendChild(tdName);
          
          const tdBy = document.createElement("td");
          tdBy.textContent = est.addedBy || "";
          tr.appendChild(tdBy);
          
          const tdReason = document.createElement("td");
          tdReason.textContent = est.reason || "";
          tr.appendChild(tdReason);
          
          const tdUrl = document.createElement("td");
          const link = document.createElement("a");
          link.href = est.url;
          link.target = "_blank";
          link.textContent = "Link";
          tdUrl.appendChild(link);
          tr.appendChild(tdUrl);
          
          // Прогресс бар и оставшееся время
          const tdTimer = document.createElement("td");
          tdTimer.style.verticalAlign = "middle";
          const progressContainer = document.createElement("div");
          progressContainer.className = "progress-container";
          progressContainer.id = `progressBar-${est.id}`;
          const progressFill = document.createElement("div");
          progressFill.className = "progress-fill";
          progressFill.id = `progressFill-${est.id}`;
          progressContainer.appendChild(progressFill);
          const timeText = document.createElement("div");
          timeText.className = "time-text";
          timeText.id = `timeText-${est.id}`;
          tdTimer.appendChild(progressContainer);
          tdTimer.appendChild(timeText);
          tr.appendChild(tdTimer);
          
          // Кнопки действий
          const tdAction = document.createElement("td");
          tdAction.style.display = "flex";
          tdAction.style.flexDirection = "column";
          tdAction.style.gap = "8px";
          
          const addTimeBtn = document.createElement("button");
          addTimeBtn.textContent = "Add Extra Time";
          addTimeBtn.className = "btn";
          addTimeBtn.addEventListener("click", () => addExtraTime(est.id));
          tdAction.appendChild(addTimeBtn);
          
          if (est.graceExpiresAt) {
            const setExpBtn = document.createElement("button");
            setExpBtn.textContent = "Set Expired";
            setExpBtn.className = "btn";
            setExpBtn.style.backgroundColor = "#dc3545";
            setExpBtn.style.marginTop = "5px";
            setExpBtn.addEventListener("click", () => setExpiredNow(est.id));
            tdAction.appendChild(setExpBtn);
          }
          tr.appendChild(tdAction);
          activeTbody.appendChild(tr);
        }
      });
      
      if (activeCount === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.textContent = "No active venues";
        tr.appendChild(td);
        activeTbody.appendChild(tr);
      }
    }

    // ------------- Update timers, grace period, and progress bar -------------
    function updateTimers() {
      const now = Date.now();
      
      currentEstablishments.forEach(est => {
        if (est.expired) return;
        
        const progressBar = document.getElementById(`progressBar-${est.id}`);
        const progressFill = document.getElementById(`progressFill-${est.id}`);
        const timeTextEl = document.getElementById(`timeText-${est.id}`);
        if (!progressBar || !progressFill || !timeTextEl) return;
        
        const offlineUntilTime = new Date(est.offlineUntil).getTime();
        const createdTime = new Date(est.createdAt).getTime();
        
        if (offlineUntilTime > now) {
          const remainingMs = offlineUntilTime - now;
          const totalMs = offlineUntilTime - createdTime;
          let ratio = remainingMs / totalMs;
          if (ratio < 0) ratio = 0;
          if (ratio > 1) ratio = 1;
          progressFill.style.backgroundColor = "#00c2ff";
          progressFill.style.width = (ratio * 100) + "%";
          const m = Math.floor(remainingMs / 60000);
          const s = Math.floor((remainingMs % 60000) / 1000);
          timeTextEl.textContent = `${m} min ${s} sec`;
        } else {
          if (est.extraTimeAdded) {
            db.ref("establishments/" + est.id).update({ expired: true }, err => {
              if (!err) {
                sendSimoNotification(`🍽️ [SIMO] ${est.name} expired immediately after extra time. URL: ${est.url} | By: ${est.addedBy}`);
              }
            });
          } else {
            if (!est.graceExpiresAt) {
              const graceExpires = new Date(now + 10 * 60 * 1000).toISOString();
              db.ref("establishments/" + est.id).update({ graceExpiresAt: graceExpires });
              sendSimoNotification(`🍽️ [SIMO] ${est.name} offline expired. Grace period (10 min) started. URL: ${est.url} | By: ${est.addedBy}`);
              est.graceExpiresAt = graceExpires;
              progressFill.style.backgroundColor = "#ffc107";
              progressFill.style.width = "100%";
              timeTextEl.textContent = "Grace: 10 min 0 sec";
            } else {
              const graceExpiresTime = new Date(est.graceExpiresAt).getTime();
              const graceRemaining = graceExpiresTime - now;
              if (graceRemaining > 0) {
                const mm = Math.floor(graceRemaining / 60000);
                const ss = Math.floor((graceRemaining % 60000) / 1000);
                progressFill.style.backgroundColor = "#ffc107";
                progressFill.style.width = ((graceRemaining / (10 * 60 * 1000)) * 100) + "%";
                timeTextEl.textContent = `Grace: ${mm} min ${ss} sec`;
              } else {
                db.ref("establishments/" + est.id).update({ expired: true }, error => {
                  if (!error) {
                    sendSimoNotification(`🍽️ [SIMO] ${est.name} fully expired. URL: ${est.url} | By: ${est.addedBy}`);
                  }
                });
              }
            }
          }
        }
      });
    }

    // ------------- Add Extra Time -------------
    function addExtraTime(id) {
      const additionalTime = prompt("Enter additional time (in minutes):");
      if (!additionalTime) return;
      
      const ref = db.ref("establishments/" + id);
      ref.once("value", snapshot => {
        const est = snapshot.val();
        if (!est) return;
        const additionalMs = parseInt(additionalTime, 10) * 60 * 1000;
        const newOfflineUntil = new Date(new Date(est.offlineUntil).getTime() + additionalMs);
        ref.update({
          offlineUntil: newOfflineUntil.toISOString(),
          expired: false,
          graceExpiresAt: null,
          createdAt: new Date().toISOString(),
          extraTimeAdded: true
        }, error => {
          if (!error) {
            sendSimoNotification(`🍽️ [SIMO] Extra ${additionalTime} min added to ${est.name}. New offline until: ${newOfflineUntil.toLocaleString()} | URL: ${est.url} | By: ${est.addedBy}`);
            db.ref("establishments").once("value", snap => {
              const data = snap.val();
              currentEstablishments = data ? Object.values(data) : [];
              renderDashboards(currentEstablishments);
            });
          } else {
            console.error("Update error:", error);
          }
        });
      });
    }

    // ------------- Set Expired Now -------------
    function setExpiredNow(id) {
      const ref = db.ref("establishments/" + id);
      ref.update({ expired: true }, error => {
        if (!error) {
          ref.once("value", snap => {
            const est = snap.val();
            sendSimoNotification(`🍽️ [SIMO] ${est.name} marked as expired. URL: ${est.url} | By: ${est.addedBy}`);
          });
        }
      });
    }

    // ------------- Initialization -------------
    window.addEventListener("load", () => {
      subscribeToDashboard();
      setInterval(updateTimers, 1000);
    });

    // ------------- Modal Window Logic -------------
    const addVenueBtn = document.getElementById("addVenueBtn");
    const modalOverlay = document.getElementById("modalOverlay");
    const venueModal = document.getElementById("venueModal");
    const cancelModalBtn = document.getElementById("cancelModalBtn");
    const venueForm = document.getElementById("venueForm");

    let isModalOpen = false;

    function openModal() {
      modalOverlay.style.display = "flex";
      setTimeout(() => {
        venueModal.classList.add("show");
      }, 10);
      isModalOpen = true;
    }

    function closeModal() {
      venueModal.classList.remove("show");
      setTimeout(() => {
        modalOverlay.style.display = "none";
        isModalOpen = false;
      }, 300);
    }

    addVenueBtn.addEventListener("click", openModal);
    cancelModalBtn.addEventListener("click", closeModal);

    // ------------- Form Handling -------------
    venueForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      // Собираем данные из модального окна (используем уникальные id для модальной формы)
      const addedBy = document.getElementById("modalAddedBy").value;
      const name = document.getElementById("modalName").value;
      const url = document.getElementById("modalUrl").value;
      const offlineTimeMinutes = parseInt(document.getElementById("modalOfflineTime").value, 10);
      const reason = document.getElementById("modalReason").value;
      
      const now = new Date();
      const offlineUntil = new Date(now.getTime() + offlineTimeMinutes * 60 * 1000);
      
      const establishment = {
        addedBy: addedBy,
        name: name,
        url: url,
        offlineUntil: offlineUntil.toISOString(),
        addedOfflineTime: offlineTimeMinutes,
        reason: reason,
        expired: false,
        graceExpiresAt: null,
        createdAt: now.toISOString(),
        extraTimeAdded: false
      };
      
      // Добавляем заведение в базу (Firebase)
      addEstablishment(establishment);
      
      // Закрываем модальное окно и очищаем форму
      closeModal();
      venueForm.reset();
    });
  </script>
</body>
</html>
